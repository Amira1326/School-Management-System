<?php
session_start();

// تفاصيل الاتصال بقاعدة البيانات
$dsn = 'mysql:host=localhost;dbname=aljood_center;charset=utf8';
$username = 'root'; // استبدل بـ اسم المستخدم لقاعدة البيانات الخاصة بك
$password = ''; // استبدل بـ كلمة المرور لقاعدة البيانات الخاصة بك

// إنشاء الاتصال بقاعدة البيانات باستخدام PDO
try {
    $pdo = new PDO($dsn, $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("خطأ في الاتصال بقاعدة البيانات: " . $e->getMessage());
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['save_grades'])) {
    
    // التحقق من وجود البيانات الأساسية
    if (!isset($_POST['subject_id']) || !isset($_POST['الفصل_الدراسي']) || !isset($_POST['المرحلة_الدراسية']) || !isset($_POST['رقم_الفصل']) || !isset($_POST['الفصل']) || !isset($_POST['المادة']) || !isset($_POST['students'])) {
        die("خطأ: البيانات المرسلة غير مكتملة.");
    }
    
    // استلام البيانات من النموذج
    $subject_id = $_POST['subject_id'];
    $الفصل_الدراسي = $_POST['الفصل_الدراسي'];
    $المرحلة_الدراسية = $_POST['المرحلة_الدراسية'];
    $class_id = $_POST['رقم_الفصل'];
    $selected_فصل = $_POST['الفصل'];
    $selected_subject_name = $_POST['المادة'];
    $students_grades = $_POST['students'];

    // تحضير استعلامات الإدراج والتحديث
    $stmt = $pdo->prepare("
        INSERT INTO grades (رقم_الطالب, subject_id, الفصل_الدراسي, المرحلة_الدراسية, رقم_الفصل, الاختبار_النهائي, الغياب, السلوك, الواجبات, الأنشطة_وأوراق_العمل, المشاركة, الاختبار_الدوري_الأول, الاختبار_الدوري_الثاني, الاختبار_النصفي)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ON DUPLICATE KEY UPDATE 
        الاختبار_النهائي = VALUES(الاختبار_النهائي),
        الغياب = VALUES(الغياب),
        السلوك = VALUES(السلوك),
        الواجبات = VALUES(الواجبات),
        الأنشطة_وأوراق_العمل = VALUES(الأنشطة_وأوراق_العمل),
        المشاركة = VALUES(المشاركة),
        الاختبار_الدوري_الأول = VALUES(الاختبار_الدوري_الأول),
        الاختبار_الدوري_الثاني = VALUES(الاختبار_الدوري_الثاني),
        الاختبار_النصفي = VALUES(الاختبار_النصفي)
    ");

    foreach ($students_grades as $student_id => $grades) {
        $الاختبار_النهائي = $grades['الاختبار_النهائي'] ?? null;
        $الغياب = $grades['الغياب'] ?? null;
        $السلوك = $grades['السلوك'] ?? null;
        $الواجبات = $grades['الواجبات'] ?? null;
        $الأنشطة_وأوراق_العمل = $grades['الأنشطة_وأوراق_العمل'] ?? null;
        $المشاركة = $grades['المشاركة'] ?? null;
        $الاختبار_الدوري_الأول = $grades['الاختبار_الدوري_الأول'] ?? null;
        $الاختبار_الدوري_الثاني = $grades['الاختبار_الدوري_الثاني'] ?? null;
        $الاختبار_النصفي = $grades['الاختبار_النصفي'] ?? null;

        $stmt->execute([
            $student_id,
            $subject_id,
            $الفصل_الدراسي,
            $المرحلة_الدراسية,
            $class_id,
            $الاختبار_النهائي,
            $الغياب,
            $السلوك,
            $الواجبات,
            $الأنشطة_وأوراق_العمل,
            $المشاركة,
            $الاختبار_الدوري_الأول,
            $الاختبار_الدوري_الثاني,
            $الاختبار_النصفي
        ]);
    }
    
    // تعديل هذا الجزء ليتلقى القيم من POST بدلاً من GET
    $params = http_build_query([
        'المرحلة_الدراسية' => $_POST['المرحلة_الدراسية'],
        'الفصل' => $_POST['الفصل'],
        'المادة' => $_POST['المادة'],
        'الفصل_الدراسي' => $_POST['الفصل_الدراسي'],
        'saved' => 'true'
    ]);
    header("Location: manage_grades.php?" . $params);
    exit();
}
?><?php
session_start();

// تفاصيل الاتصال بقاعدة البيانات
$dsn = 'mysql:host=localhost;dbname=aljood_center;charset=utf8';
$username = 'root'; // استبدل بـ اسم المستخدم لقاعدة البيانات الخاصة بك
$password = ''; // استبدل بـ كلمة المرور لقاعدة البيانات الخاصة بك

// إنشاء الاتصال بقاعدة البيانات باستخدام PDO
try {
    $pdo = new PDO($dsn, $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("خطأ في الاتصال بقاعدة البيانات: " . $e->getMessage());
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['save_grades'])) {
    
    // التحقق من وجود البيانات الأساسية
    if (!isset($_POST['subject_id']) || !isset($_POST['الفصل_الدراسي']) || !isset($_POST['المرحلة_الدراسية']) || !isset($_POST['رقم_الفصل']) || !isset($_POST['الفصل']) || !isset($_POST['المادة']) || !isset($_POST['students'])) {
        die("خطأ: البيانات المرسلة غير مكتملة.");
    }
    
    // استلام البيانات من النموذج
    $subject_id = $_POST['subject_id'];
    $الفصل_الدراسي = $_POST['الفصل_الدراسي'];
    $المرحلة_الدراسية = $_POST['المرحلة_الدراسية'];
    $class_id = $_POST['رقم_الفصل'];
    $selected_فصل = $_POST['الفصل'];
    $selected_subject_name = $_POST['المادة'];
    $students_grades = $_POST['students'];

    // تحضير استعلامات الإدراج والتحديث
    $stmt = $pdo->prepare("
        INSERT INTO grades (رقم_الطالب, subject_id, الفصل_الدراسي, المرحلة_الدراسية, رقم_الفصل, الاختبار_النهائي, الغياب, السلوك, الواجبات, الأنشطة_وأوراق_العمل, المشاركة, الاختبار_الدوري_الأول, الاختبار_الدوري_الثاني, الاختبار_النصفي)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ON DUPLICATE KEY UPDATE 
        الاختبار_النهائي = VALUES(الاختبار_النهائي),
        الغياب = VALUES(الغياب),
        السلوك = VALUES(السلوك),
        الواجبات = VALUES(الواجبات),
        الأنشطة_وأوراق_العمل = VALUES(الأنشطة_وأوراق_العمل),
        المشاركة = VALUES(المشاركة),
        الاختبار_الدوري_الأول = VALUES(الاختبار_الدوري_الأول),
        الاختبار_الدوري_الثاني = VALUES(الاختبار_الدوري_الثاني),
        الاختبار_النصفي = VALUES(الاختبار_النصفي)
    ");

    foreach ($students_grades as $student_id => $grades) {
        $الاختبار_النهائي = $grades['الاختبار_النهائي'] ?? null;
        $الغياب = $grades['الغياب'] ?? null;
        $السلوك = $grades['السلوك'] ?? null;
        $الواجبات = $grades['الواجبات'] ?? null;
        $الأنشطة_وأوراق_العمل = $grades['الأنشطة_وأوراق_العمل'] ?? null;
        $المشاركة = $grades['المشاركة'] ?? null;
        $الاختبار_الدوري_الأول = $grades['الاختبار_الدوري_الأول'] ?? null;
        $الاختبار_الدوري_الثاني = $grades['الاختبار_الدوري_الثاني'] ?? null;
        $الاختبار_النصفي = $grades['الاختبار_النصفي'] ?? null;

        $stmt->execute([
            $student_id,
            $subject_id,
            $الفصل_الدراسي,
            $المرحلة_الدراسية,
            $class_id,
            $الاختبار_النهائي,
            $الغياب,
            $السلوك,
            $الواجبات,
            $الأنشطة_وأوراق_العمل,
            $المشاركة,
            $الاختبار_الدوري_الأول,
            $الاختبار_الدوري_الثاني,
            $الاختبار_النصفي
        ]);
    }
    
    // تعديل هذا الجزء ليتلقى القيم من POST بدلاً من GET
    $params = http_build_query([
        'المرحلة_الدراسية' => $_POST['المرحلة_الدراسية'],
        'الفصل' => $_POST['الفصل'],
        'المادة' => $_POST['المادة'],
        'الفصل_الدراسي' => $_POST['الفصل_الدراسي'],
        'saved' => 'true'
    ]);
    header("Location: manage_grades.php?" . $params);
    exit();
}
?>